name: Setup SOPS and Decrypt Secrets

# Reusable workflow for decrypting SOPS secrets in GitHub Actions
# Usage:
#   jobs:
#     setup-secrets:
#       uses: ./.github/workflows/setup-sops.yml
#       secrets: inherit

on:
  workflow_call:
    outputs:
      cachix_token:
        description: "Decrypted Cachix authentication token"
        value: ${{ jobs.decrypt.outputs.cachix_token }}
      github_token:
        description: "Decrypted GitHub personal access token"
        value: ${{ jobs.decrypt.outputs.github_token }}

jobs:
  decrypt:
    runs-on: [self-hosted, nixos]
    outputs:
      cachix_token: ${{ steps.decrypt.outputs.cachix_token }}
      github_token: ${{ steps.decrypt.outputs.github_token }}

    steps:

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          lfs: false
          fetch-depth: 0

      - name: Setup AGE key for SOPS
        env:
          AGE_SECRET_KEY: ${{ secrets.AGE_SECRET_KEY }}
        run: |
          set -euo pipefail

          # Validate secret is not empty
          if [[ -z "$AGE_SECRET_KEY" ]]; then
            echo "‚ùå AGE_SECRET_KEY is empty"
            exit 1
          fi

          # Create SOPS AGE directory
          mkdir -p ~/.config/sops/age

          # Write AGE private key with trimmed lines (remove leading/trailing spaces)
          # The secret might have been copied with indentation
          echo "$AGE_SECRET_KEY" | sed 's/^[[:space:]]*//;s/[[:space:]]*$//' > ~/.config/sops/age/keys.txt
          chmod 600 ~/.config/sops/age/keys.txt

          # Debug: show file structure (not content)
          echo "üìù AGE key file structure:"
          echo "   Lines: $(wc -l < ~/.config/sops/age/keys.txt)"
          echo "   Size: $(wc -c < ~/.config/sops/age/keys.txt) bytes"
          echo "   First 20 chars: $(head -c 20 ~/.config/sops/age/keys.txt)..."

          # Check each line type
          while IFS= read -r line; do
            if [[ "$line" =~ ^#.* ]]; then
              echo "   - Comment line detected"
            elif [[ "$line" =~ ^AGE-SECRET-KEY-1.* ]]; then
              echo "   - Valid AGE secret key detected"
            elif [[ -z "$line" ]]; then
              echo "   - Empty line detected"
            else
              echo "   - Unknown line type: ${line:0:20}..."
            fi
          done < ~/.config/sops/age/keys.txt

          # Verify key format
          if ! grep -q "AGE-SECRET-KEY-1" ~/.config/sops/age/keys.txt; then
            echo "‚ùå No valid AGE secret key found"
            exit 1
          fi

          echo "‚úÖ AGE key configured"

      - name: Verify SOPS installation
        run: |
          # sops is available via extraPackages
          sops --version
          echo "‚úÖ SOPS is available"

      - name: Decrypt secrets
        id: decrypt
        env:
          SOPS_AGE_KEY_FILE: ${{ github.workspace }}/.sops-age-key
        run: |
          set -euo pipefail

          # Copy AGE key to workspace for SOPS
          cp ~/.config/sops/age/keys.txt "$SOPS_AGE_KEY_FILE"
          chmod 600 "$SOPS_AGE_KEY_FILE"

          echo "üîì Decrypting secrets..."

          # Verify secrets file exists
          if [[ ! -f secrets/github.yaml ]]; then
            echo "‚ùå secrets/github.yaml not found"
            exit 1
          fi

          # Test SOPS decryption first
          echo "üîç Testing SOPS decryption..."
          if ! sops -d secrets/github.yaml > /tmp/decrypted.yaml 2>&1; then
            echo "‚ùå SOPS decryption failed:"
            cat /tmp/decrypted.yaml
            rm -f /tmp/decrypted.yaml
            exit 1
          fi

          echo "‚úÖ SOPS decryption successful"

          # Extract Cachix token
          CACHIX_TOKEN=$(yq eval '.github.cachix_auth_token // ""' /tmp/decrypted.yaml)

          # Extract GitHub PAT
          GITHUB_PAT=$(yq eval '.github.personal_access_token // ""' /tmp/decrypted.yaml)

          # Clean up decrypted file
          rm -f /tmp/decrypted.yaml

          # Set outputs (masked)
          if [[ -n "$CACHIX_TOKEN" ]]; then
            echo "::add-mask::$CACHIX_TOKEN"
            echo "cachix_token=$CACHIX_TOKEN" >> $GITHUB_OUTPUT
            echo "‚úÖ Cachix token extracted (${#CACHIX_TOKEN} chars)"
          else
            echo "‚ö†Ô∏è  Cachix token not found or empty"
          fi

          if [[ -n "$GITHUB_PAT" ]]; then
            echo "::add-mask::$GITHUB_PAT"
            echo "github_token=$GITHUB_PAT" >> $GITHUB_OUTPUT
            echo "‚úÖ GitHub PAT extracted (${#GITHUB_PAT} chars)"
          else
            echo "‚ö†Ô∏è  GitHub PAT not found or empty"
          fi

          echo "‚úÖ Secrets processing complete"

      - name: Cleanup sensitive files
        if: always()
        run: |
          # Remove AGE keys and temporary files
          rm -f ~/.config/sops/age/keys.txt
          rm -f "${{ github.workspace }}/.sops-age-key"
          rm -f /tmp/decrypted.yaml
          echo "üßπ Cleanup complete"

      - name: Verify secrets (without exposing values)
        run: |
          echo "Secret verification:"
          if [[ -n "${{ steps.decrypt.outputs.cachix_token }}" ]]; then
            CACHIX_TOKEN="${{ steps.decrypt.outputs.cachix_token }}"
            CACHIX_LEN="${#CACHIX_TOKEN}"
            echo "  ‚úÖ Cachix token: Available (${CACHIX_LEN} chars)"
          else
            echo "  ‚ö†Ô∏è  Cachix token: Not available"
          fi

          if [[ -n "${{ steps.decrypt.outputs.github_token }}" ]]; then
            GITHUB_TOKEN="${{ steps.decrypt.outputs.github_token }}"
            GITHUB_LEN="${#GITHUB_TOKEN}"
            echo "  ‚úÖ GitHub token: Available (${GITHUB_LEN} chars)"
          else
            echo "  ‚ö†Ô∏è  GitHub token: Not available"
          fi
