name: 'Rollback System'

on:
  workflow_dispatch:
    inputs:
      generation:
        description: 'Generation number to rollback to (empty for previous)'
        required: false
        default: ''
      reason:
        description: 'Reason for rollback'
        required: true
      notify-team:
        description: 'Send notification to team'
        required: false
        default: 'true'
        type: boolean

jobs:
  rollback:
    name: Execute Rollback
    runs-on: [self-hosted, nixos]
    steps:
      - name: Disable Git LFS globally
        run: |
          git config --global --unset filter.lfs.clean || true
          git config --global --unset filter.lfs.smudge || true
          git config --global --unset filter.lfs.process || true
          git config --global --unset filter.lfs.required || true

      - name: Checkout
        uses: actions/checkout@v4
        with:
          lfs: false
          fetch-depth: 0
          clean: true

      - name: Identify rollback target
        id: identify
        run: |
          echo "ðŸ” Identifying rollback target..."
          
          if [ -z "${{ inputs.generation }}" ]; then
            echo "Rolling back to previous generation"
            GENERATION="previous"
          else
            echo "Rolling back to generation ${{ inputs.generation }}"
            GENERATION="${{ inputs.generation }}"
          fi
          
          echo "generation=$GENERATION" >> $GITHUB_OUTPUT
          
          # List available generations
          echo "Available generations:"
          sudo nix-env --list-generations -p /nix/var/nix/profiles/system | tail -10

      - name: Backup current state
        id: backup
        run: |
          echo "ðŸ’¾ Backing up current state..."
          
          CURRENT_GEN=$(sudo nix-env --list-generations -p /nix/var/nix/profiles/system | grep '(current)' | awk '{print $1}')
          echo "current_generation=$CURRENT_GEN" >> $GITHUB_OUTPUT
          
          # Save current configuration
          sudo cp -r /etc/nixos /tmp/nixos-backup-$CURRENT_GEN
          
          echo "âœ… Current generation $CURRENT_GEN backed up"

      - name: Perform rollback
        id: rollback
        run: |
          echo "â®ï¸  Performing rollback..."
          
          if [ "${{ steps.identify.outputs.generation }}" == "previous" ]; then
            sudo nixos-rebuild switch --rollback
          else
            sudo nix-env --switch-generation ${{ steps.identify.outputs.generation }} -p /nix/var/nix/profiles/system
            sudo /nix/var/nix/profiles/system/bin/switch-to-configuration switch
          fi
          
          NEW_GEN=$(sudo nix-env --list-generations -p /nix/var/nix/profiles/system | grep '(current)' | awk '{print $1}')
          echo "new_generation=$NEW_GEN" >> $GITHUB_OUTPUT
          
          echo "âœ… Rolled back to generation $NEW_GEN"

      - name: Verify system health
        id: verify
        run: |
          echo "ðŸ” Verifying system health..."
          
          # Check systemd services
          echo "Checking failed services..."
          FAILED_SERVICES=$(systemctl --failed --no-legend | wc -l)
          
          if [ $FAILED_SERVICES -gt 0 ]; then
            echo "âš ï¸  Warning: $FAILED_SERVICES services failed"
            systemctl --failed
          else
            echo "âœ… No failed services"
          fi
          
          # Check journal errors
          echo "Checking recent errors..."
          ERRORS=$(journalctl -p err -n 20 --no-pager | wc -l)
          
          if [ $ERRORS -gt 0 ]; then
            echo "âš ï¸  Warning: $ERRORS errors in journal"
            journalctl -p err -n 20 --no-pager
          else
            echo "âœ… No critical errors"
          fi
          
          # Check disk space
          echo "Checking disk space..."
          df -h /
          
          echo "health_status=ok" >> $GITHUB_OUTPUT

      - name: Generate rollback report
        run: |
          echo "## Rollback Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Details" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Reason**: ${{ inputs.reason }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Previous Generation**: ${{ steps.backup.outputs.current_generation }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Rollback Target**: ${{ steps.identify.outputs.generation }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Current Generation**: ${{ steps.rollback.outputs.new_generation }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Health Status**: ${{ steps.verify.outputs.health_status }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### System Health" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          systemctl --failed --no-legend || echo "No failed services" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Rollback completed successfully" >> $GITHUB_STEP_SUMMARY

      - name: Notify team
        if: inputs.notify-team && always()
        uses: ./.github/actions/notify
        with:
          status: ${{ steps.verify.outputs.health_status == 'ok' && 'warning' || 'failure' }}
          title: "System Rollback Performed"
          message: |
            **Reason**: ${{ inputs.reason }}
            **From**: Generation ${{ steps.backup.outputs.current_generation }}
            **To**: Generation ${{ steps.rollback.outputs.new_generation }}
            **Status**: ${{ steps.verify.outputs.health_status }}
            **Triggered by**: ${{ github.actor }}
          discord-webhook: ${{ secrets.DISCORD_WEBHOOK }}
          slack-webhook: ${{ secrets.SLACK_WEBHOOK }}
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Rollback failed
        if: failure()
        run: |
          echo "## âŒ Rollback Failed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "The rollback process encountered errors." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Recovery Steps" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "1. Check system logs: \`journalctl -xeu nixos-rebuild.service\`" >> $GITHUB_STEP_SUMMARY
          echo "2. Manual rollback: \`sudo nixos-rebuild switch --rollback\`" >> $GITHUB_STEP_SUMMARY
          echo "3. Restore from backup: \`/tmp/nixos-backup-${{ steps.backup.outputs.current_generation }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Immediate action required!**" >> $GITHUB_STEP_SUMMARY