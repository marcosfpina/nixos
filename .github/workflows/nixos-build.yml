name: NixOS Build & Test

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  workflow_dispatch:
    inputs:
      deploy:
        description: "Deploy to system after build"
        required: false
        default: false
        type: boolean
      enable-tmate:
        description: "Enable tmate debug session"
        required: false
        default: false
        type: boolean
      tmate-on-failure:
        description: "Enable tmate only on failure"
        required: false
        default: true
        type: boolean

env:
  CACHIX_CACHE_NAME: marcosfpina

jobs:
  # SOPS: Decrypt secrets first
  setup-secrets:
    name: Decrypt SOPS secrets
    uses: ./.github/workflows/setup-sops.yml
    secrets: inherit

  check:
    name: Check Nix flake
    runs-on: [self-hosted, nixos]
    needs: setup-secrets
    steps:
      - name: Ensure Nix daemon is running
        run: systemctl is-active --quiet nix-daemon || sudo systemctl restart nix-daemon

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          lfs: false
          fetch-depth: 0

      - name: Ensure Git tracking for Nix
        run: |
          git add -A
          git status --short

      - name: Setup Cachix
        uses: cachix/cachix-action@v15
        with:
          name: ${{ env.CACHIX_CACHE_NAME }}
          authToken: ${{ needs.setup-secrets.outputs.cachix_token }}
          pushFilter: "(-source$|-env$)"

      - name: Check flake syntax
        run: nix flake check --show-trace

      - name: Validate flake metadata
        run: nix flake metadata

      - name: Check for eval errors
        run: |
          nix eval .#nixosConfigurations.kernelcore.config.system.build.toplevel.drvPath --show-trace

  build:
    name: Build NixOS configuration
    runs-on: [self-hosted, nixos]
    needs: [setup-secrets, check]
    strategy:
      fail-fast: false  # Continue outros jobs se um falhar
      max-parallel: 3   # Limita jobs simult√¢neos
      matrix:
        target: [toplevel, iso, vm-image]
    steps:

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          lfs: false
          fetch-depth: 0

      - name: Ensure Git tracking for Nix
        run: |
          git add -A
          git status --short

      - name: Setup Cachix
        uses: cachix/cachix-action@v15
        with:
          name: ${{ env.CACHIX_CACHE_NAME }}
          authToken: ${{ needs.setup-secrets.outputs.cachix_token }}
          pushFilter: "(-source$|-env$)"

      - name: Build ${{ matrix.target }}
        id: build
        run: |
          BUILD_START=$(date +%s)

          case "${{ matrix.target }}" in
            toplevel)
              echo "Building main system configuration..."
              nix build .#nixosConfigurations.kernelcore.config.system.build.toplevel \
                --show-trace --print-build-logs
              ;;
            iso)
              echo "Building ISO image..."
              nix build .#packages.x86_64-linux.iso \
                --show-trace --print-build-logs
              ;;
            vm-image)
              echo "Building VM image..."
              nix build .#packages.x86_64-linux.vm-image \
                --show-trace --print-build-logs
              ;;
          esac

          BUILD_END=$(date +%s)
          BUILD_TIME=$((BUILD_END - BUILD_START))
          echo "build_time=${BUILD_TIME}" >> $GITHUB_OUTPUT

      # NOTE: Artifacts n√£o s√£o armazenados para evitar GBs de ISO/VM images desnecess√°rios
      # O Cachix j√° fornece cache distribu√≠do e os builds ficam dispon√≠veis localmente no runner

      - name: Build performance metrics
        if: matrix.target == 'toplevel'
        run: |
          echo "## üìä Build Metrics - ${{ matrix.target }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Build time
          echo "- ‚è±Ô∏è Build Time: ${{ steps.build.outputs.build_time }}s" >> $GITHUB_STEP_SUMMARY

          # Closure size
          SIZE=$(nix path-info -Sh .#nixosConfigurations.kernelcore.config.system.build.toplevel | awk '{print $2}')
          echo "- üì¶ Closure Size: $SIZE" >> $GITHUB_STEP_SUMMARY

          # Dependencies count
          DEPS=$(nix-store -q --requisites ./result | wc -l)
          echo "- üîó Dependencies: $DEPS packages" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

  test-modules:
    name: Test NixOS modules
    runs-on: [self-hosted, nixos]
    needs: [setup-secrets, check]
    steps:

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          lfs: false
          fetch-depth: 0

      - name: Ensure Git tracking for Nix
        run: |
          git add -A
          git status --short

      - name: Setup Cachix
        uses: cachix/cachix-action@v15
        with:
          name: ${{ env.CACHIX_CACHE_NAME }}
          authToken: ${{ needs.setup-secrets.outputs.cachix_token }}

      - name: Test dev shells
        run: |
          echo "Testing development shells..."
          nix develop .#python --command python --version
          nix develop .#cuda --command nvcc --version || echo "CUDA shell test skipped (no GPU in CI)"

      - name: Test Docker images build
        run: |
          echo "Building Docker images..."
          nix build .#packages.x86_64-linux.image-app --print-build-logs

      - name: Verify systemd services syntax
        run: |
          echo "Checking systemd services..."
          nix eval .#nixosConfigurations.kernelcore.config.systemd.services --apply builtins.attrNames

  security:
    name: Security checks
    runs-on: [self-hosted, nixos]
    needs: build
    steps:

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          lfs: false
          fetch-depth: 0

      - name: Check for known vulnerabilities
        id: vulnix
        run: |
          echo "Running vulnerability scan..."
          RESULT_PATH=$(nix build .#nixosConfigurations.kernelcore.config.system.build.toplevel --no-link --print-out-paths)

          # Run vulnix and capture output
          VULNS=$(nix run nixpkgs#vulnix -- -w "$RESULT_PATH" 2>&1 | tee /tmp/vulnix.log | grep -c "CVE-" || echo "0")
          echo "vulnerabilities=${VULNS}" >> $GITHUB_OUTPUT

          if [ "$VULNS" -gt 0 ]; then
            echo "‚ö†Ô∏è Found $VULNS vulnerabilities, review required"
          else
            echo "‚úÖ No vulnerabilities found"
          fi
        continue-on-error: true

      - name: Security score report
        run: |
          echo "## üîí Security Score" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Get vulnerability count from previous step
          VULNS="${{ steps.vulnix.outputs.vulnerabilities }}"

          # Calculate score (100 - vulnerabilities, minimum 0)
          SCORE=$((100 - VULNS))
          if [ $SCORE -lt 0 ]; then
            SCORE=0
          fi

          echo "- **Security Score**: ${SCORE}/100" >> $GITHUB_STEP_SUMMARY
          echo "- **Vulnerabilities Found**: $VULNS" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Warning if score too low
          if [ $SCORE -lt 80 ]; then
            echo "::warning::Security score below threshold (80): ${SCORE}/100"
            echo "- ‚ö†Ô∏è **Status**: Below threshold (< 80)" >> $GITHUB_STEP_SUMMARY
          else
            echo "- ‚úÖ **Status**: Passed threshold (‚â• 80)" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Audit Nix store paths
        run: |
          echo "Auditing derivations..."
          nix-store --query --requisites $(nix-instantiate '<nixpkgs>' -A hello) | wc -l

      - name: Check for hardcoded secrets
        run: |
          echo "Scanning for hardcoded secrets..."

          # Pattern 1: Direct token assignments (e.g., token = "ghp_xxxxx")
          if grep -rE '(token|password|apiKey|secret)\s*=\s*"[a-zA-Z0-9_-]{20,}"' --include="*.nix" . | grep -v "config.sops"; then
            echo "‚ùå Found hardcoded secrets in plaintext!"
            exit 1
          fi

          # Pattern 2: GitHub tokens (ghp_, gho_, etc.)
          if grep -rE '(ghp_|gho_|ghs_|ghr_)[a-zA-Z0-9]{36,}' --include="*.nix" .; then
            echo "‚ùå Found exposed GitHub token!"
            exit 1
          fi

          # Pattern 3: Private keys in plaintext
          if grep -r "BEGIN.*PRIVATE KEY" --include="*.nix" .; then
            echo "‚ùå Found private key in plaintext!"
            exit 1
          fi

          echo "‚úÖ No hardcoded secrets found"

  format:
    name: Check formatting
    runs-on: [self-hosted, nixos]
    steps:

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          lfs: false
          fetch-depth: 0

      - name: Check Nix formatting
        run: nix fmt -- --check .

  deploy:
    name: Deploy to NixOS
    runs-on: [self-hosted, nixos]
    needs: [setup-secrets, build, test-modules, security, format]
    # Deploy ONLY on manual workflow_dispatch with deploy=true
    # Automatic deploy on push is disabled for safety
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.deploy == 'true'
    steps:

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          lfs: false
          fetch-depth: 0

      - name: Ensure Git tracking for Nix
        run: |
          git add -A
          git status --short

      - name: Setup Cachix
        uses: cachix/cachix-action@v15
        with:
          name: ${{ env.CACHIX_CACHE_NAME }}
          authToken: ${{ needs.setup-secrets.outputs.cachix_token }}

      - name: Build system configuration
        run: |
          echo "Building final system configuration..."
          nix build .#nixosConfigurations.kernelcore.config.system.build.toplevel \
            --print-build-logs

      - name: Deploy instructions
        run: |
          echo "‚úÖ Build completed successfully!"
          echo ""
          echo "To deploy manually, run:"
          echo "  sudo nixos-rebuild switch --flake /etc/nixos#kernelcore --max-jobs 8 --cores 8"
          echo ""
          echo "Or use the result link:"
          echo "  sudo ./result/bin/switch-to-configuration switch"

  report:
    name: Build report
    runs-on: [self-hosted, nixos]
    needs: [build, test-modules, security]
    if: always()
    steps:
      - name: Generate build summary
        run: |
          echo "## NixOS Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Build Status:** ${{ needs.build.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Tests Status:** ${{ needs.test-modules.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Security Status:** ${{ needs.security.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### System Info" >> $GITHUB_STEP_SUMMARY
          nix eval .#nixosConfigurations.kernelcore.config.system.nixos.version --raw >> $GITHUB_STEP_SUMMARY

      - name: Notify on failure
        if: ${{ failure() || needs.build.result == 'failure' || needs.test-modules.result == 'failure' || needs.security.result == 'failure' }}
        run: |
          echo "::error::CI/CD Pipeline failed! Check the logs above for details."
          echo "### ‚ùå Pipeline Failed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "One or more jobs failed. Please review the logs." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- Build: ${{ needs.build.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Tests: ${{ needs.test-modules.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Security: ${{ needs.security.result }}" >> $GITHUB_STEP_SUMMARY
