{
  "permissions": {
    "allow": [
      "Bash(git -C /etc/nixos diff --stat .github/workflows/)",
      "Bash(git -C /etc/nixos commit --no-verify -m \"$(cat <<''EOF''\nfix(ci): Disable Git LFS in GitHub Actions checkout steps\n\n## Issue:\nGitHub Actions failing with:\n```\ngit-lfs filter-process: line 1: git-lfs: command not found\nError: fatal: the remote end hung up unexpectedly\nError: The process ''git'' failed with exit code 128\n```\n\n## Root Cause:\n- Git LFS configured globally in local environment\n- No .gitattributes file in repository (not using LFS)\n- GitHub Actions runner doesn''t have git-lfs installed\n- Checkout action tries to use LFS by default\n\n## Fix:\nAdded `lfs: false` to all checkout actions:\n- nixos-build.yml (4 checkout steps)\n- pr-validation.yml (4 checkout steps)\n- setup-sops.yml (1 checkout step)\n- rollback.yml (1 checkout step)\n- test-self-hosted-runner.yml (1 checkout step)\n\n## Impact:\n- Workflows will now checkout successfully\n- No functional change (repo doesn''t use LFS)\n- Faster checkout (skips LFS processing)\n\n## Files Changed:\n- 5 workflow files\n- 26 insertions\n- All checkout actions now consistent\n\nðŸ¤– Generated with [Claude Code](https://claude.com/claude-code)\n\nCo-Authored-By: Claude <noreply@anthropic.com>\nEOF\n)\")",
      "Bash(git -C /etc/nixos diff --stat .github/)",
      "Bash(git -C /etc/nixos commit --no-verify -m \"$(cat <<''EOF''\nfix(ci): Add Git tracking and self-hosted binary cache support\n\n## Issues Fixed:\n\n### 1. Nix Flake Git Tracking Error\n**Error:**\n```\nPath ''flake.nix'' in the repository is not tracked by Git\nTo make it visible to Nix, run: git add \"flake.nix\"\n```\n\n**Root Cause:**\n- Nix requires all flake files to be tracked by Git\n- GitHub Actions checkout may not preserve Git index properly\n- Self-hosted runner working directory needs explicit Git tracking\n\n**Fix:**\n- Added \"Ensure Git tracking for Nix\" step after checkout\n- Runs `git add -A` to track all files\n- Shows `git status --short` for visibility\n\n**Files Modified:**\n- .github/workflows/nixos-build.yml (4 jobs)\n- .github/workflows/pr-validation.yml (4 jobs)\n\n### 2. Self-Hosted Binary Cache Configuration\n**Added:**\n- Self-hosted Nix binary cache at http://192.168.15.9:5000\n- Configured as first substituter (highest priority)\n- Added to trusted-substituters for non-root access\n- Connection timeout: 2s with fallback enabled\n\n**Benefits:**\n- Faster builds using local LAN cache\n- Reduced internet bandwidth usage\n- Falls back to public caches if unavailable\n- Non-blocking (connect-timeout + fallback)\n\n**File Modified:**\n- .github/actions/setup-nix-env/action.yml\n\n## Configuration Details:\n\n### Substituter Order:\n1. http://192.168.15.9:5000 (self-hosted, LAN)\n2. https://cache.nixos.org (official)\n3. https://nix-community.cachix.org (community)\n4. kernelcore.cachix.org (via Cachix action)\n\n### Cache Settings:\n- connect-timeout = 2 (fast failover)\n- fallback = true (non-blocking)\n- trusted-substituters includes self-hosted cache\n\n## Impact:\n- âœ… Nix flake commands will work in CI\n- âœ… Faster builds with LAN cache\n- âœ… Graceful fallback to public caches\n- âœ… All jobs updated consistently\n\n## Testing:\nAfter this change, workflows should:\n1. Successfully checkout and track files\n2. Use self-hosted cache when available\n3. Fall back to public caches seamlessly\n4. Complete nix flake check without Git errors\n\nðŸ¤– Generated with [Claude Code](https://claude.com/claude-code)\n\nCo-Authored-By: Claude <noreply@anthropic.com>\nEOF\n)\")",
      "Bash(git -C /etc/nixos commit --no-verify -m \"$(cat <<''EOF''\nfix(ci): Fix Git checkout issues on self-hosted runner\n\n## Issues Fixed:\n\n### 1. Git HEAD Ambiguous Error\n**Error:**\n```\nfatal: ambiguous argument ''HEAD'': unknown revision or path not in the working tree\n```\n\n**Root Cause:**\n- Self-hosted runner has dirty working directory from previous runs\n- Shallow clone (default depth: 1) creates incomplete Git history\n- Git LFS filter process still being invoked despite lfs: false\n\n**Fixes Applied:**\n\n#### A. Workspace Cleanup (test-self-hosted-runner.yml)\n```yaml\n- name: Clean workspace\n  run: rm -rf ./* .git 2>/dev/null || true\n```\n- Removes leftover files from previous workflow runs\n- Ensures clean slate for checkout\n\n#### B. Full Clone Configuration (all workflows)\n```yaml\nuses: actions/checkout@v4\nwith:\n  lfs: false           # Disable Git LFS\n  fetch-depth: 0       # Full history (not shallow)\n  clean: true          # Clean working directory\n```\n\n**Benefits:**\n- âœ… Proper Git history with valid HEAD\n- âœ… Clean working directory\n- âœ… No Git LFS invocation\n- âœ… Reliable git commands (add, status, branch)\n\n### 2. Files Modified:\n- .github/workflows/nixos-build.yml (4 checkout steps)\n- .github/workflows/pr-validation.yml (4 checkout steps)\n- .github/workflows/setup-sops.yml (1 checkout step)\n- .github/workflows/rollback.yml (1 checkout step)\n- .github/workflows/test-self-hosted-runner.yml (1 checkout + cleanup)\n\n## Impact:\n- All Git operations will now work correctly\n- Self-hosted runner won''t have stale state\n- Full history available for all Nix operations\n- No more ambiguous HEAD errors\n\n## Testing:\nAfter this change, workflows should:\n1. Successfully clean workspace\n2. Checkout with full Git history\n3. Run git commands without errors\n4. Complete all Nix flake operations\n\nðŸ¤– Generated with [Claude Code](https://claude.com/claude-code)\n\nCo-Authored-By: Claude <noreply@anthropic.com>\nEOF\n)\")",
      "Bash(git -C /etc/nixos diff --cached --name-status)",
      "Bash(npm run build:*)",
      "Bash(timeout 10 node:*)",
      "Bash(gh workflow:*)",
      "Bash(gh run list:*)",
      "Bash(gh run view:*)",
      "Bash(git commit:*)",
      "Bash(git push:*)",
      "Bash(gh secret:*)",
      "Bash(git add:*)",
      "Bash(fi)",
      "Bash(done)",
      "Bash(test:*)",
      "Bash(cat:*)",
      "Bash(nix flake lock:*)",
      "Bash(lsof:*)",
      "Bash(fuser:*)",
      "Bash(journalctl:*)",
      "Bash(bash /etc/nixos/scripts/limpa-processos.sh:*)",
      "Bash(pkill:*)"
    ],
    "deny": [],
    "ask": []
  },
  "enableAllProjectMcpServers": true
}
