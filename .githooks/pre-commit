#!/usr/bin/env bash
# Pre-commit hook: Format check and syntax validation
# Installed via: git config core.hooksPath .githooks

set -e

echo "ğŸ” Running pre-commit checks..."

# Check Nix formatting
echo "  â†’ Checking Nix formatting..."
if ! nix fmt -- --check . 2>/dev/null; then
  echo "âŒ Formatting check failed"
  echo "ğŸ’¡ Fix with: nix fmt"
  exit 1
fi

# Validate flake syntax (no-build for speed)
echo "  â†’ Validating flake syntax..."
if ! nix flake check --no-build 2>/dev/null; then
  echo "âŒ Flake syntax check failed"
  echo "ğŸ’¡ Run: nix flake check --show-trace"
  exit 1
fi

# Check for common mistakes
echo "  â†’ Checking for common issues..."

# Check for hardcoded secrets (excluding SOPS encrypted files)
if git diff --cached --name-only | grep -v "\.yaml$" | xargs grep -l "ghp_\|sk-ant-\|sk-" 2>/dev/null; then
  echo "âŒ Potential hardcoded secrets detected!"
  echo "ğŸ’¡ Use SOPS for secrets: sops secrets/github.yaml"
  exit 1
fi

# Check for TODO without issue reference
if git diff --cached | grep -i "^+.*TODO" | grep -v "#[0-9]"; then
  echo "âš ï¸  TODO comment without issue reference found"
  echo "ğŸ’¡ Link TODOs to issues: TODO(#123): description"
  # Warning only, don't fail
fi

echo "âœ… Pre-commit checks passed!"
